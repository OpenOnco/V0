#!/bin/bash
# OpenOnco Preview: smoke tests â†’ push to develop â†’ Vercel preview URL

set -e
cd "$(dirname "$0")"

echo "ðŸ§ª Running smoke tests..."
npm run test:smoke

echo ""
echo "âœ… Tests passed. Pushing to develop..."
git add -A
git commit -m "${1:-wip: preview}" --allow-empty
git push

echo ""
echo "â³ Waiting for Vercel deployment..."
sleep 20

# Capture vercel ls output and extract URL
VERCEL_OUTPUT=$(vercel ls 2>&1 | grep -E "Preview|Ready" | head -1)
PREVIEW_URL=$(echo "$VERCEL_OUTPUT" | grep -oE "https://[^ ]+\.vercel\.app" | head -1)

echo ""
echo "ðŸš€ Preview deployed!"
if [ -n "$PREVIEW_URL" ]; then
  echo ""
  echo "ðŸ“Ž $PREVIEW_URL"
  echo ""
else
  echo "ðŸ“Ž Check: https://vercel.com/alex-dickinsons-projects-2bee58ff/v0-42kj/deployments"
fi
