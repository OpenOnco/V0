name: Sync MCP Data

on:
  push:
    branches:
      - main
    paths:
      - 'src/data.js'
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync even if no changes detected'
        required: false
        default: 'false'
        type: boolean

jobs:
  sync-mcp-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout OpenOnco repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if data.js was modified
        id: check_changes
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger detected"
            if [ "${{ inputs.force_sync }}" = "true" ]; then
              echo "Force sync enabled - proceeding"
              echo "should_continue=true" >> $GITHUB_OUTPUT
            else
              echo "Checking if src/data.js exists..."
              if [ -f "src/data.js" ]; then
                echo "src/data.js exists - proceeding"
                echo "should_continue=true" >> $GITHUB_OUTPUT
              else
                echo "src/data.js not found - skipping"
                echo "should_continue=false" >> $GITHUB_OUTPUT
              fi
            fi
          else
            echo "Push event - verifying src/data.js was actually changed..."
            if git diff --name-only HEAD~1 HEAD | grep -q "^src/data.js$"; then
              echo "src/data.js was modified - proceeding"
              echo "should_continue=true" >> $GITHUB_OUTPUT
            else
              echo "src/data.js was not in the changed files - skipping"
              echo "should_continue=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Setup Node.js
        if: steps.check_changes.outputs.should_continue == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        if: steps.check_changes.outputs.should_continue == 'true'
        run: |
          echo "Installing dependencies..."
          npm ci
          echo "Dependencies installed successfully"

      - name: Export MCP data
        if: steps.check_changes.outputs.should_continue == 'true'
        run: |
          echo "Running MCP data export..."
          npm run export:mcp
          echo "MCP data export completed"
          echo "Generated files:"
          ls -la dist/mcp/

      - name: Checkout openonco-mcp repo
        if: steps.check_changes.outputs.should_continue == 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/openonco-mcp
          path: openonco-mcp
          token: ${{ secrets.MCP_REPO_TOKEN }}

      - name: Copy JSON files to MCP repo
        if: steps.check_changes.outputs.should_continue == 'true'
        run: |
          echo "Copying JSON files to openonco-mcp..."

          TARGET_DIR="openonco-mcp/src/main/resources"
          mkdir -p "$TARGET_DIR"

          # Copy all JSON files from dist/mcp/
          cp dist/mcp/*.json "$TARGET_DIR/"

          echo "Files copied to $TARGET_DIR:"
          ls -la "$TARGET_DIR"/*.json

      - name: Check for changes and commit
        if: steps.check_changes.outputs.should_continue == 'true'
        id: commit_changes
        run: |
          cd openonco-mcp

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add src/main/resources/*.json

          if git diff --staged --quiet; then
            echo "No changes to JSON files - nothing to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected in JSON files:"
            git diff --staged --stat

            git commit -m "chore: sync MCP data from OpenOnco" -m "Automated sync from src/data.js" -m "Source: ${{ github.sha }}"

            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Push changes to openonco-mcp
        if: steps.check_changes.outputs.should_continue == 'true' && steps.commit_changes.outputs.has_changes == 'true'
        working-directory: openonco-mcp
        run: |
          echo "Pushing changes to openonco-mcp..."
          git remote set-url origin https://x-access-token:${{ secrets.MCP_REPO_TOKEN }}@github.com/OpenOnco/openonco-mcp.git
          git push
          echo "Successfully pushed changes to openonco-mcp"

      - name: Summary
        if: always()
        run: |
          echo "=== Sync Summary ==="
          echo "Event: ${{ github.event_name }}"
          echo "Should continue: ${{ steps.check_changes.outputs.should_continue }}"
          if [ "${{ steps.check_changes.outputs.should_continue }}" = "true" ]; then
            echo "Has changes: ${{ steps.commit_changes.outputs.has_changes }}"
            if [ "${{ steps.commit_changes.outputs.has_changes }}" = "true" ]; then
              echo "Status: Changes synced successfully"
            else
              echo "Status: No changes to sync (data.js changed but JSON output unchanged)"
            fi
          else
            echo "Status: Skipped (src/data.js not modified)"
          fi
